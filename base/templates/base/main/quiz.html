{% extends "main.html" %}

{% block content %}
<div class="mb-6 px-2 max-w-2xl mx-auto">
    <h2 class="text-2xl font-semibold mb-3">{{ ct.topic.title }} Quiz</h2>

    <div class="w-full">
        <div class="w-full bg-base-100 rounded-full h-4 overflow-hidden">
            <div id="quiz-progress-bar" class="h-full bg-secondary transition-all duration-300" style="width: 0%;">
            </div>
        </div>
        <p id="quiz-progress-label" class="text-sm text-right mt-1 text-base-content/70">0 of {{ questions|length }}
            answered</p>
    </div>
</div>

<div class="overflow-y-auto max-h-[80vh] pr-2">
    <form method="POST" action="" class="space-y-6" onsubmit="hasSubmittedQuiz = true;">
        {% csrf_token %}

        {% for question in questions %}
        <div class="card bg-base-100 shadow-lg p-4 space-y-2 mb-2">

            {% if quiz.question_type == "multiple_choice" %}
            {% include "base/components/quiz_components/mc_question_block.html" with question=question %}
            {% elif quiz.question_type == "tracing" %}
            {% include "base/components/quiz_components/tracing_question_block.html" with question=question %}
            {% elif quiz.question_type == "fill_in_the_blank" %}
            {% include "base/components/quiz_components/fill_in_the_blank_question_block.html" with question=question %}
            {% else %}
            <p class="text-error">Unsupported question type.</p>
            {% endif %}

        </div>
        {% endfor %}

        <button type="submit" class="btn btn-primary w-full mt-6">Submit Quiz</button>
    </form>
</div>

<!-- Debugging information -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const progressBar = document.getElementById("quiz-progress-bar");
        const progressLabel = document.getElementById("quiz-progress-label");
        const total = parseInt("{{ questions|length }}", 10);
        const radios = document.querySelectorAll("input[type='radio']");

        function updateProgress() {
            const answered = new Set();
            radios.forEach(input => {
                if (input.checked) {
                    answered.add(input.name);
                }
            });

            const count = answered.size;
            const percent = (count / total) * 100;
            progressBar.style.width = `${percent}%`;
            progressLabel.textContent = `${count} of ${total} answered`;
        }

        radios.forEach(input => {
            input.addEventListener("change", updateProgress);
        });

        updateProgress();
    });
</script>


<script>
    console.log("Activity allow_resubmission:", "{{ activity.allow_resubmission }}");
</script>

<!-- Forfeiting quiz with confirmation modal -->
{% if not activity.allow_resubmission %}
<script>
    let hasSubmittedQuiz = false;
    let forfeitModalShown = false;
    let tabSwitchTimer = null;
    const gracePeriod = 5000; // 5 seconds

    const quizId = "{{ quiz.id }}";
    const activityId = "{{ activity.id }}";
    const courseId = "{{ course_id }}";
    const forfeitUrl = `/quiz/${quizId}/${activityId}/forfeit/`;

    // Create modal and toast
    const modalHtml = `
        <div id="forfeit-modal" class="modal">
            <div class="modal-box">
                <h3 class="font-bold text-lg">Warning: Forfeit Quiz?</h3>
                <p class="py-4">Leaving the quiz page will forfeit your attempt and assign a score of 0. Are you sure you want to continue?</p>
                <div class="modal-action">
                    <button id="forfeit-confirm" class="btn btn-error">Confirm</button>
                    <button id="forfeit-cancel" class="btn btn-outline">Cancel</button>
                </div>
            </div>
        </div>
        <div id="grace-toast" class="toast toast-top toast-center hidden z-50">
            <div class="alert alert-warning shadow-lg">
                <span>You left the quiz. It will be forfeited in 5 seconds if you don't return.</span>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = document.getElementById('forfeit-modal');
    const confirmButton = document.getElementById('forfeit-confirm');
    const cancelButton = document.getElementById('forfeit-cancel');
    const graceToast = document.getElementById('grace-toast');

    function showForfeitModal(callback, targetUrl = null) {
        if (forfeitModalShown || hasSubmittedQuiz) return;
        forfeitModalShown = true;

        modal.classList.add('modal-open');
        confirmButton.onclick = () => {
            modal.classList.remove('modal-open');
            callback(targetUrl);
        };
        cancelButton.onclick = () => {
            modal.classList.remove('modal-open');
            forfeitModalShown = false;
        };
    }

    function forfeitQuiz(targetUrl = null) {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", forfeitUrl, false); // Synchronous
        xhr.setRequestHeader("X-CSRFToken", document.querySelector("[name=csrfmiddlewaretoken]").value);
        xhr.send();

        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            localStorage.setItem("flashMessage", `
                <div class="font-bold text-lg">Quiz Forfeited</div>
                <div>You navigated away from the quiz for too long.</div>
                <div>Your attempt has been <strong>forfeited</strong> and marked as <strong>0</strong>.</div>
                <div class="text-sm text-base-100/80">Please contact your teacher if this was a mistake.</div>
            `);
            window.location.href = targetUrl || `/quiz/${response.ac_id}/results/`;
        } else {
            console.error("Forfeit request failed:", xhr.status, xhr.statusText);
            window.location.href = `/course/${courseId}/`;
        }
    }

    // Handle internal navigation
    document.addEventListener("click", function (event) {
        const target = event.target.closest("a");
        if (
            target &&
            target.href &&
            !hasSubmittedQuiz &&
            target.origin === window.location.origin &&
            (!target.target || target.target === "_self")
        ) {
            event.preventDefault();
            showForfeitModal(forfeitQuiz, target.href);
        }
    });

    function startGraceTimer() {
        graceToast.classList.remove("hidden");
        tabSwitchTimer = setTimeout(() => {
            graceToast.classList.add("hidden");

            // Extra check to make sure student didn't return in time
            if (!hasSubmittedQuiz && document.visibilityState === "hidden") {
                forfeitQuiz();
            } else {
                console.log("ðŸŸ¢ Student returned before timeout â€” forfeit cancelled.");
            }
        }, gracePeriod);

    }

    function clearGraceTimer() {
        if (tabSwitchTimer) {
            clearTimeout(tabSwitchTimer);
            tabSwitchTimer = null;
            graceToast.classList.add("hidden");
        }
    }

    // Tab switch or minimize
    document.addEventListener("visibilitychange", function () {
        if (hasSubmittedQuiz) return;
        if (document.visibilityState === "hidden") {
            startGraceTimer();
        } else {
            clearGraceTimer();
        }
    });

    // Switch to another browser window
    window.addEventListener("blur", function () {
        if (!hasSubmittedQuiz && document.visibilityState === "visible") {
            startGraceTimer();
        }
    });

    window.addEventListener("focus", clearGraceTimer);
</script>

<style>
    .modal {
        display: none;
        place-items: center;
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-open {
        display: grid;
    }

    .toast {
        position: fixed;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
    }
</style>
{% endif %}

{% endblock %}