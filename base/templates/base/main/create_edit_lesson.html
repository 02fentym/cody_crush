{% extends "main.html" %}

{% block content %}

{% if form.errors %}
  <div class="alert alert-error text-sm">
    {{ form.errors }}
  </div>
{% endif %}

<div class="p-4">
  <div class="card bg-base-100 shadow-md p-6 space-y-6">
    <h2 class="text-2xl font-semibold">
      {% if is_edit %}Edit Lesson{% else %}Create Lesson{% endif %}
    </h2>

    <form method="POST" class="lesson-form space-y-4">
      {% csrf_token %}

      {% if form.non_field_errors %}
      <div class="alert alert-error text-sm">
        {{ form.non_field_errors }}
      </div>
      {% endif %}

      <!-- Title Field -->
      <div class="form-control">
        <label for="{{ form.title.id_for_label }}" class="label">
          <span class="label-text font-medium">Title</span>
        </label>
        {{ form.title }}
        {% if form.title.errors %}
        <p class="text-error text-sm">{{ form.title.errors }}</p>
        {% endif %}
      </div>

      <!-- Markdown Editor -->
      <div class="form-control">
        <label for="editor" class="label text-primary-content">
          <span class="label-text font-medium">Content (Markdown)</span>
        </label>

        <!-- ðŸ‘‡ Toast UI mounts here -->
        <div id="editor"></div>

        <!-- ðŸ‘‡ Hidden textarea gets filled before submit -->
        <textarea id="id_content" name="content" class="hidden">{{ form.content.value|default_if_none:"" }}</textarea>
        {% if form.content.errors %}
        <p class="text-error text-sm">{{ form.content.errors }}</p>
        {% endif %}
      </div>

      <!-- Buttons -->
      <div class="flex gap-4 justify-end pt-4">
        <button type="submit" class="btn btn-primary btn-outline">
          {% if is_edit %}Save{% else %}Create{% endif %}
        </button>
        <button type="button" onclick="window.history.back()" class="btn btn-outline">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const { Editor } = toastui;
    const { codeSyntaxHighlight } = Editor.plugin;

    console.log("Script loaded");

    const editor = new Editor({
      el: document.querySelector('#editor'),
      height: '500px',
      initialEditType: 'markdown',
      previewStyle: 'vertical',
      initialValue: document.getElementById('id_content').value,
      plugins: [codeSyntaxHighlight],
      toolbarItems: [
        ['heading', 'bold', 'italic', 'strike'],
        ['hr', 'quote'],
        ['ul', 'ol', 'task'],
        ['table', 'link', 'image'],
        ['code', 'codeblock'],
        ['scrollSync']
      ]
    });

    const form = document.querySelector('.lesson-form');
    const textarea = document.getElementById('id_content');

    if (!form) {
      console.warn("Lesson form not found");
    } else {
      form.addEventListener('submit', function () {
        console.log("Syncing content");
        if (textarea) {
          textarea.value = editor.getMarkdown();
        } else {
          console.warn("Textarea not found");
        }
      });
    }
  });
</script>

{% endblock %}
